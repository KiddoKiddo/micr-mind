<!doctype html>
<html>
<head>
  <title>MICR Mind Control</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <link rel="stylesheet" href="css/control-test.css">
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col">
        <h1>MICR Mind Control</h1>
      </div>
    </div>
    <div class="row height-90">
      <div class="col">
        <div class="row">
          <div class="col-2">
            <label for="event">Event:</label>
          </div>
          <div class="col">
            <input id="event" class="form-control-lg" type="text" value="send-to-mind">
          </div>
        </div>
        <div class="row">
          <div class="col-2">
            <label for="data">Data:</label>
          </div>
          <div class="col">
            <textarea id="data" class="form-control">
            </textarea>
          </div>
        </div>
        <div class="row">
          <div class="col-2"></div>
          <div class="col">
            <button id="send" class="btn-lg btn-secondary" type="button">Send event to control</button>
          </div>
        </div>
      </div>
      <div class="col-5">
        <ul id="messages" class="list-group"></ul>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
    $(function () {

      const defaultData = '{"event": "message", "data": { "text": "Information in the MICR", "choices": null}}';
      $('#data').val(JSON.stringify(JSON.parse(defaultData), null, '\t'));

      const addMessage = (msg, className) => {
        if(typeof msg === 'object') {
          msg = JSON.stringify(msg);
        }
        $('#messages').prepend($('<li class="list-group-item '+className+'">').text(msg));
      }

      // Socket IO connection
      const socket = io('/control');
      socket.on('message', (msg) => addMessage(msg));

      // Send to Mind
      $('#send').click(() => {
        const event = $('#event').val();
        const data = $('#data').val().replace(/[\t\n]+/g,' ');
        if( ! event.trim()) {
          addMessage('Pls input event field.', 'list-group-item-danger');
        } else {
          socket.emit(event, data);
          addMessage('Event: ' + event + ', Data: ' + data, 'list-group-item-success');
        }
      });

      // Format JSON
      $('#data').focusout( () => {
        const data = $('#data').val();
        let pretty;
        try {
          const json = JSON.parse(data);
          pretty = JSON.stringify(json, null, '\t');
        } catch (e) {
          pretty = data;
        }
        $('#data').val(pretty);
      });

      enableTab('data');
    });

    // To enable tab edit in textarea
    function enableTab(id) {
      var el = document.getElementById(id);
      el.onkeydown = function(e) {
        if (e.keyCode === 9) { // tab was pressed

          // get caret position/selection
          var val = this.value,
          start = this.selectionStart,
          end = this.selectionEnd;

          // set textarea value to: text before caret + tab + text after caret
          this.value = val.substring(0, start) + '\t' + val.substring(end);

          // put caret at right position again
          this.selectionStart = this.selectionEnd = start + 1;

          // prevent the focus lose
          return false;

        }
      };
    }
    </script>
  </body>
  </html>
